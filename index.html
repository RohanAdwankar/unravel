<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>unravel</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --accent-color: #000;
            --border-color: #e9ecef;
            --hover-color: #f1f3f5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            line-height: 1.5;
            display: flex;
            justify-content: center;
        }

        #app {
            width: 100%;
            max-width: 600px;
        }

        h1 {
            font-weight: 700;
            letter-spacing: -0.05em;
            margin-bottom: 2rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        input[type="text"] {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--accent-color);
        }

        button {
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button:hover:not(:disabled) {
            opacity: 0.8;
        }

        #status {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 1rem;
            min-height: 1.5em;
        }

        /* Tree Styles */
        .tree-list {
            list-style: none;
            padding-left: 1.5rem;
            margin: 0;
            border-left: 1px solid var(--border-color);
        }

        #root-list {
            padding-left: 0;
            border-left: none;
            list-style: none;
        }

        .tree-item {
            margin: 0.5rem 0;
        }

        .item-content {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        .item-content:hover {
            background-color: var(--hover-color);
        }

        .toggle-icon {
            margin-right: 0.5rem;
            width: 12px;
            height: 12px;
            transition: transform 0.2s;
            display: inline-block;
            fill: currentColor;
            opacity: 0.5;
        }

        .expanded > .item-content > .toggle-icon {
            transform: rotate(90deg);
        }

        .item-text {
            font-weight: 500;
        }

        .loading-dots::after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ''; }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>unravel</h1>
        <div id="status">Initializing AI engine... (this may take a moment)</div>
        
        <div class="controls">
            <input type="text" id="seed-input" value="startup ideas" placeholder="Enter a topic to unravel...">
            <button id="start-btn" disabled>Start</button>
        </div>

        <div id="tree-container">
            <ul id="root-list"></ul>
        </div>
    </div>

    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";

        const statusEl = document.getElementById("status");
        const startBtn = document.getElementById("start-btn");
        const seedInput = document.getElementById("seed-input");
        const rootList = document.getElementById("root-list");

        let engine;
        const selectedModel = "Llama-3.2-1B-Instruct-q4f16_1-MLC";

        const chevronRight = `<svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg>`;

        async function initEngine() {
            try {
                startBtn.disabled = true;
                
                const createdEngine = await webllm.CreateMLCEngine(selectedModel, {
                    initProgressCallback: (p) => {
                        statusEl.innerText = p.text;
                    }
                });
                
                engine = createdEngine;
                statusEl.innerText = "Engine ready. Click start to unravel.";
                startBtn.disabled = false;
                
            } catch (err) {
                statusEl.innerText = "Error loading engine: " + err.message;
                console.error(err);
            }
        }

        async function fetchCategories(lineage) {
            const currentTopic = lineage[lineage.length - 1];
            const context = lineage.join(" > ");
            
            const prompt = `The user is navigating a specific hierarchy: ${context}.
            Generate a comma-separated list of 5 distinct, specific sub-categories or types of "${currentTopic}" that strictly belong within this hierarchy.
            Do not repeat the parent category name. Be precise and specific.
            Return ONLY the list separated by commas. Do not number them. Do not include the word and`;

            try {
                if (!engine) throw new Error("Engine not initialized");

                const response = await engine.chat.completions.create({
                    messages: [{ role: "user", content: prompt }],
                    temperature: 0.7,
                    max_tokens: 100,
                });
                
                const text = response.choices[0].message.content;
                const items = text.split(',')
                    .map(s => s.trim())
                    .filter(s => s.length > 0 && !s.toLowerCase().includes("here is a list"));
                return items.slice(0, 8);
            } catch (e) {
                console.error("Generation error", e);
                return ["Error generating items. Try again."];
            }
        }

        function createTreeItem(text, lineage) {
            const li = document.createElement("li");
            li.className = "tree-item";
            
            const content = document.createElement("div");
            content.className = "item-content";
            
            const icon = document.createElement("span");
            icon.className = "toggle-icon";
            icon.innerHTML = chevronRight;
            
            const span = document.createElement("span");
            span.className = "item-text";
            span.innerText = text;

            content.appendChild(icon);
            content.appendChild(span);
            li.appendChild(content);

            const childrenUl = document.createElement("ul");
            childrenUl.className = "tree-list hidden";
            li.appendChild(childrenUl);

            let loaded = false;
            let loading = false;
            let expanded = false;

            const newLineage = [...lineage, text];

            content.onclick = async (e) => {
                e.stopPropagation();

                if (loading) return;

                expanded = !expanded;
                
                if (expanded) {
                    li.classList.add("expanded");
                    childrenUl.classList.remove("hidden");

                    if (!loaded) {
                        loading = true;
                        const originalText = span.innerText;
                        span.classList.add("loading-dots");
                        statusEl.innerText = `Unravelling ${originalText}...`;

                        const categories = await fetchCategories(newLineage);
                        
                        loading = false;
                        loaded = true;
                        span.classList.remove("loading-dots");
                        statusEl.innerText = "Ready.";

                        if (categories.length > 0) {
                            categories.forEach(cat => {
                                childrenUl.appendChild(createTreeItem(cat, newLineage));
                            });
                        } else {
                             const empty = document.createElement("li");
                             empty.innerText = "(No sub-categories found)";
                             empty.style.paddingLeft = "2rem";
                             empty.style.color = "#999";
                             childrenUl.appendChild(empty);
                        }
                    }
                } else {
                    li.classList.remove("expanded");
                    childrenUl.classList.add("hidden");
                }
            };

            return li;
        }

        startBtn.onclick = async () => {
            if (!engine) return; 

            const topic = seedInput.value.trim();
            if (!topic) return;

            rootList.innerHTML = "";
            
            startBtn.disabled = true;
            statusEl.innerText = `Unravelling ${topic}...`;
            
            const initialLineage = [topic];
            const categories = await fetchCategories(initialLineage);
            
            categories.forEach(cat => {
                rootList.appendChild(createTreeItem(cat, initialLineage));
            });
            
            statusEl.innerText = "Ready.";
            startBtn.disabled = false;
        };

        initEngine();

    </script>
</body>
</html>
